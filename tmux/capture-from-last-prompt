#!/bin/sh

# `-S 0` visible, `-S -10` ten lines in hist, `-S -` beginning
# -J to wrap and preserve whitespace
tmux capture-pane -Jp -S - "$@" | \
  perl -ne '
    $esc = qr/(?:\e\[[0-9;]+[a-z])/;
    # if last line and current line combine to make multi line prompt...
    if ($o[-1] =~ /(^ðŸ¤–Â |$esc+ðŸ¤–Â $esc+)/ && /^$esc*ðŸ’¥$esc*/) {
      pop @o;
      @l = @o if @o;
      @o = $ENV{CAPTURE_PROMPT} ? s/^$esc*ðŸ’¥$esc*\h+(.+?)\h*$/\$ $1/r : ();
    }
    else {
      push @o, $_
    }
    END { print @l }
  '
