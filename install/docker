#!/bin/bash

. `dirname "$0"`/../scripts/.helpers.sh

if is_mac; then
  have docker || {
    #$rc/mac/install docker-beta
    homebrew docker
  }

  have docker-machine || homebrew docker-machine
  have xhyve || \
    homebrew xhyve docker-machine-driver-xhyve

  # > docker-machine-driver-xhyve need root owner and uid
  _ () {
    [[ `stat -c '%U' "$1"` = root ]] || sudo chown root:wheel "$1";
    [[ `stat -c '%a' "$1"` = 4555 ]] || sudo chmod u+s "$1";
  }; \
      _ $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve

  have dinghy || {
    homebrew-tap codekitchen/dinghy
    homebrew dinghy
  }

  dinghy status | grep -qF 'VM: not created' && \
    dinghy create --provider virtualbox --memory 6144 --cpus 4 --disk 100000

  exit
fi

# ಠ_ಠ
have docker || \
  wget -qO- https://get.docker.com/ | sh

compose_tag=1.6.0
download-bin "https://github.com/docker/compose/releases/download/${compose_tag}/docker-compose-`uname -s`-`uname -m`" docker-compose

ensure-in-group docker
